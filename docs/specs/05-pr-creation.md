# Spec 05: PR Creation

## Purpose

Create structured pull requests that clearly communicate changes, test results, and implementation details to reviewers.

---

## Overview

The PR creation layer is the final delivery mechanism for Loom. It takes verified code changes and creates a GitHub pull request with a comprehensive description that enables efficient human review.

---

## Context

**Position in Pipeline:**
```
04: Verification ‚Üí [05: PR Creation] ‚Üí 06: Orchestration (Complete)
```

**Dependencies:**
- Test Verification (provides decision and report)
- GitHub Service (creates PR)
- Code Implementation (provides changes)

---

## Workflow

### Step 1: Verify Pre-Conditions

**Goal:** Ensure all requirements are met before creating PR.

**Checks:**
- [ ] Tests passed (verification gate allowed)
- [ ] Feature branch exists
- [ ] Changes committed and pushed
- [ ] No merge conflicts with base branch
- [ ] Issue is still open

**Failure:** If any check fails, log error and mark task as failed.

---

### Step 2: Generate PR Title

**Goal:** Create clear, descriptive title following conventions.

**Rules:**
- Conventional commit format: `<type>: <description>`
- Types: `feat`, `fix`, `refactor`, `docs`, `test`, `chore`
- Include issue number: `(#<issue-number>)`

**Examples:**
```
feat: add user authentication (#42)
fix: resolve memory leak in cache handler (#45)
refactor: improve API response formatting (#48)
```

---

### Step 3: Generate PR Description

**Goal:** Create comprehensive, human-readable description.

**Template:**
```markdown
## Summary

[1-2 sentence description of what this PR does]

## Changes

- [Change 1]
- [Change 2]
- [Change 3]

## Testing

### Test Results

<test results summary>

**Status:** ‚úÖ PASSED / ‚ùå FAILED
**Total:** 42 tests
**Passed:** 42
**Failed:** 0
**Duration:** 12.3s

### Coverage

- Statements: 85%
- Branches: 78%
- Functions: 90%
- Lines: 84%

## Implementation Notes

[Any important implementation details, design decisions, or edge cases]

## Breaking Changes

[Yes/No - If yes, describe what breaks and how to migrate]

## Checklist

- [x] Tests pass
- [x] Code follows project style guidelines
- [x] Added/updated tests for new functionality
- [x] Updated documentation if needed
- [x] No merge conflicts

---

### ü§ñ Generated by Loom

This PR was automatically generated by Loom based on issue #<issue-number>.

**Agent Type:** <agent-type>
**Task ID:** <task-id>
**Review the issue:** https://github.com/<owner>/<repo>/issues/<issue-number>
```

---

### Step 4: Create Draft PR

**Goal:** Create pull request in GitHub.

**Parameters:**
- **Title:** Generated PR title
- **Body:** Generated PR description
- **Base:** Repository's default branch
- **Head:** Feature branch name
- **Draft:** `true` (require manual review before marking ready)

**GitHub API Call:**
```typescript
const pr = await octokit.rest.pulls.create({
  owner: repository.owner.login,
  repo: repository.name,
  title: prTitle,
  body: prDescription,
  base: repository.default_branch,
  head: branchName,
  draft: true
})
```

---

### Step 5: Add Labels

**Goal:** Label PR for easy filtering and triage.

**Labels:**
- `loom:auto` - Auto-generated PR
- `loom:ready` - Ready for review
- `type:feat` / `type:fix` / `type:refactor` - Type of change
- `area:<area>` - Area of code affected

**GitHub API Call:**
```typescript
await octokit.rest.issues.addLabels({
  owner: repository.owner.login,
  repo: repository.name,
  issue_number: pr.data.number,
  labels: ['loom:auto', 'loom:ready', getTypeLabel(issue), getAreaLabel(issue)]
})
```

---

### Step 6: Request Reviewers

**Goal:** Assign reviewers based on configuration.

**Options:**
- **Specific reviewers:** List of usernames from config
- **Code owner rules:** Use GitHub CODEOWNERS file
- **Random:** Assign random team member (for MVP)

**GitHub API Call:**
```typescript
await octokit.rest.pulls.requestReviewers({
  owner: repository.owner.login,
  repo: repository.name,
  pull_number: pr.data.number,
  reviewers: configuredReviewers
})
```

---

### Step 7: Link to Issue

**Goal:** Connect PR to original issue for tracking.

**GitHub API Call:**
```typescript
// Add PR comment to issue with reference
await octokit.rest.issues.createComment({
  owner: repository.owner.login,
  repo: repository.name,
  issue_number: issue.number,
  body: `ü§ñ **Loom has created a PR for this issue:** #${pr.data.number}\n\nPlease review and provide feedback.`
})

// Or use GitHub's automatic linking if supported
// GitHub automatically links issues mentioned in PR body
```

---

### Step 8: Update Task

**Goal:** Mark task as completed with PR information.

**Database Update:**
```sql
UPDATE tasks
SET
  status = 'completed',
  pr_number = ${prNumber},
  updated_at = CURRENT_TIMESTAMP
WHERE id = ${taskId}
```

**Log Event:**
```sql
INSERT INTO task_logs (task_id, level, message, metadata)
VALUES (${taskId}, 'info', 'PR created', ${JSON.stringify({
  prNumber: prNumber,
  prUrl: prUrl
})})
```

---

## Success Criteria

**PR creation is successful when:**

1. **Pre-Conditions Met**
   - All checks pass
   - Task allowed to proceed

2. **PR Created**
   - Pull request created in GitHub
   - PR URL generated
   - PR number recorded

3. **Description Complete**
   - Title follows conventions
   - Description includes all sections
   - Test results embedded
   - Implementation notes included

4. **Labels Added**
   - PR labeled with `loom:auto`
   - Type label added (feat/fix/refactor)
   - Area label added

5. **Reviewers Assigned**
   - At least one reviewer requested
   - Reviewer list follows config

6. **Issue Linked**
   - PR linked to original issue
   - Comment added to issue (or auto-linked)

7. **Task Updated**
   - Task status set to `completed`
   - PR number stored
   - Completion timestamp set

---

## Error Handling

### Error Types

| Error | Severity | Action |
|-------|----------|--------|
| Pre-condition failed | High | Log error, mark task failed |
| GitHub API error (4xx) | High | Retry 2 times, then fail |
| GitHub API error (5xx) | Medium | Retry 3 times with backoff |
| PR already exists | Low | Log warning, use existing PR |
| Merge conflict | High | Attempt rebase, or fail |
| Reviewer assignment failed | Low | Log warning, continue |

### Retry Strategy

**GitHub API Failures:**
- 4xx errors (client): Retry 2 times
- 5xx errors (server): Retry 3 times with exponential backoff (1s, 2s, 4s)
- Rate limit errors: Wait for reset, then retry

**Merge Conflicts:**
- Attempt automatic rebase
- If rebase fails: Log error, mark task failed, add comment to issue

---

## Configuration

```typescript
interface PRCreationConfig {
  draftMode: boolean          // default: true
  autoReviewers: string[]     // default: []
  useCodeOwners: boolean      // default: false
  labelPrefix: string         // default: 'loom'
  linkToIssue: boolean        // default: true
  addCommentToIssue: boolean  // default: true
  prTemplate: string          // default: use built-in template
}
```

---

## Testing Requirements

### Unit Tests

**Test Suite: `pr-creation.spec.ts`**

1. **PR Title Generation**
   - ‚úÖ Generate title for feature
   - ‚úÖ Generate title for bugfix
   - ‚úÖ Include issue number
   - ‚úÖ Follow conventional commit format

2. **PR Description Generation**
   - ‚úÖ Generate description with all sections
   - ‚úÖ Include test results
   - ‚úÖ Add implementation notes
   - ‚úÖ Format as markdown

3. **PR Creation**
   - ‚úÖ Create PR successfully
   - ‚úÖ Set draft mode correctly
   - ‚úÖ Handle API errors with retries
   - ‚úÖ Handle rate limits

4. **Label Management**
   - ‚úÖ Add `loom:auto` label
   - ‚úÖ Add type label (feat/fix/refactor)
   - ‚úÖ Add area label if available
   - ‚úÖ Handle label creation failures

5. **Reviewer Assignment**
   - ‚úÖ Assign specific reviewers
   - ‚úÖ Use CODEOWNERS if enabled
   - ‚úÖ Handle assignment failures gracefully

6. **Issue Linking**
   - ‚úÖ Link PR to issue via comment
   - ‚úÖ Include PR URL in comment
   - ‚úÖ Handle comment creation failures

7. **Task Updates**
   - ‚úÖ Update task status to completed
   - ‚úÖ Store PR number
   - ‚úÖ Log PR creation event

### Integration Tests

**Test Suite: `pr-creation.integration.spec.ts`**

1. **Full Workflow**
   - Verify pre-conditions ‚Üí create PR ‚Üí add labels ‚Üí assign reviewers
   - Verify PR created in GitHub
   - Verify task updated in database

2. **Error Scenarios**
   - Merge conflict ‚Üí attempt rebase or fail gracefully
   - GitHub API rate limit ‚Üí wait and retry
   - Reviewer assignment fails ‚Üí create PR anyway
   - PR already exists ‚Üí use existing PR

---

## Implementation Notes

### GitHub Service

```typescript
// packages/integrations/src/github/pr-creation.ts
export const PRCreationService = Effect.gen(function* () {
  const config = yield* PRCreationConfig
  const octokit = yield* GitHubClient

  return {
    createPR: (issue: GitHubIssue, changes: GeneratedChanges, testReport: TestReport) =>
      Effect.gen(function* () {
        // 1. Generate PR title
        const title = generatePRTitle(issue, changes)

        // 2. Generate PR description
        const description = generatePRDescription(issue, changes, testReport, config)

        // 3. Create PR
        const pr = yield* octokit.rest.pulls.create({
          owner: issue.repository.owner.login,
          repo: issue.repository.name,
          title,
          body: description,
          base: issue.repository.default_branch,
          head: `loom/${issue.number}`,
          draft: config.draftMode
        })

        // 4. Add labels
        yield* addLabels(issue, pr.data.number, changes)

        // 5. Request reviewers
        if (config.autoReviewers.length > 0 || config.useCodeOwners) {
          yield* requestReviewers(issue, pr.data.number)
        }

        // 6. Link to issue
        if (config.linkToIssue) {
          yield* linkToIssue(issue, pr.data)
        }

        return {
          number: pr.data.number,
          url: pr.data.html_url,
          state: pr.data.state
        }
      })
  }
})
```

### Effect Workflow Structure

```typescript
// packages/core/src/pr-creation/pr-creation.ts
export const PRCreationWorkflow = Effect.gen(function* () {
  const github = yield* PRCreationService
  const database = yield* DatabaseService

  return {
    create: (
      issue: GitHubIssue,
      changes: GeneratedChanges,
      testReport: TestReport,
      branchName: string
    ) =>
      Effect.gen(function* () {
        // 1. Verify pre-conditions
        yield* verifyPreConditions(issue, branchName, testReport)

        // 2. Create PR
        const pr = yield* github.createPR(issue, changes, testReport)

        // 3. Update task
        yield* database.updateTask(taskId, {
          status: 'completed',
          prNumber: pr.number,
          completedAt: new Date()
        })

        // 4. Log event
        yield* database.logTaskEvent(taskId, 'info', 'PR created', {
          prNumber: pr.number,
          prUrl: pr.url
        })

        return pr
      })
  }
})
```

---

## Performance Considerations

1. **Rate Limiting:** Respect GitHub rate limits (5,000/hr for authenticated requests)
2. **Batch Operations:** Can combine label and reviewer requests in parallel
3. **Caching:** Cache CODEOWNERS file to avoid repeated reads
4. **Timeout:** Set 30-second timeout for all GitHub API calls

---

## Success Metrics

- **PR Success Rate:** > 95% of PRs created successfully
- **PR Quality:** > 80% of PRs approved without major revisions
- **PR Response Time:** < 10 seconds from verification to PR creation
- **Reviewer Assignment:** > 90% of PRs have reviewers assigned

---

## Open Questions

1. **Review Process:** Should PRs be automatically marked as "ready for review" or stay in draft?
2. **Comment Iteration:** Should agent respond to PR comments automatically?
3. **PR Updates:** Should agent update PR if tests fail after submission?
4. **PR Merging:** Should agent merge PRs automatically after approval?

---

## Next Steps

After implementing this spec, proceed to:
- **Spec 06: Orchestration Workflow** - Full pipeline coordination
- **Spec 07: Web Dashboard** - Monitoring UI
